server {
    listen 80;

    # Internal endpoint for auth_request
    location = /_auth {
        internal;
        proxy_pass http://api:8000/auth/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
    }

    # Allow anonymous preview access
    location /previews/ {
        proxy_pass http://api:8000/previews/;
    }

    # Protect all other routes
    location / {
        auth_request /_auth;
        proxy_pass http://api:8000;
    }
}
